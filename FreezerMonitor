blueprint:
  name: Freezer Door Alert with Light Restore (Fixed)
  description: >
    When a freezer door stays open longer than a set time, turn on a light with alert color/brightness.
    When the door closes, restore the original on/off state, color, and brightness.
  domain: automation
  input:
    door_sensor:
      name: Freezer Door Sensor
      selector:
        entity:
          domain: binary_sensor
    light_entity:
      name: Alert Light
      selector:
        entity:
          domain: light
    delay_time:
      name: Delay Time (seconds)
      default: 60
      selector:
        number:
          min: 5
          max: 600
          unit_of_measurement: seconds
          mode: slider
    alert_color:
      name: Alert Color (RGB)
      default: [255, 0, 0]
      selector:
        color_rgb: {}
    alert_brightness:
      name: Alert Brightness (0â€“255)
      default: 200
      selector:
        number:
          min: 1
          max: 255
          mode: slider
    notify_device:
      name: Notify Device
      selector:
        device:
          integration: mobile_app

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input door_sensor
    to: 'on'

variables:
  light: !input light_entity
  alert_color: !input alert_color
  alert_brightness: !input alert_brightness
  notify_service: >
    notify.mobile_app_{{ device_attr('!input notify_device', 'name') | lower | replace(' ', '_') }}

action:
  - variables:
      # Capture current light state
      light_was_on: "{{ is_state(light, 'on') }}"
      old_rgb: >
        {% set color = state_attr(light, 'rgb_color') %}
        {{ color if color is not none else [255, 255, 255] }}
      old_brightness: >
        {% set bright = state_attr(light, 'brightness') %}
        {{ bright if bright is not none else 255 }}

  - wait_for_trigger:
      - platform: state
        entity_id: !input door_sensor
        to: 'off'
    timeout: !input delay_time
    continue_on_timeout: true

  - choose:
      - conditions:
          - condition: state
            entity_id: !input door_sensor
            state: 'on'
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ light }}"
            data:
              rgb_color: "{{ alert_color }}"
              brightness: "{{ alert_brightness }}"
          - service: "{{ notify_service }}"
            data:
              title: "Freezer Door Left Open"
              message: "Freezer door has been in 'Opening' state for more than {{ delay_time }} seconds!"
      - conditions:
          - condition: state
            entity_id: !input door_sensor
            state: 'off'
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ light_was_on }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ light }}"
                    data:
                      rgb_color: "{{ old_rgb }}"
                      brightness: "{{ old_brightness }}"
              - conditions:
                  - condition: template
                    value_template: "{{ not light_was_on }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light }}"
